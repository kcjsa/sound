<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>匿名P2Pラジオ</title>
<style>
body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; margin:0; }
h1 { margin:10px; }
button { padding:10px 20px; margin:5px; font-size:16px }
#programs { width:90%; max-width:500px; margin-top:10px }
.program { display:flex; justify-content:space-between; margin:5px 0 }
audio { margin-top:10px; width:90%; max-width:500px }
</style>
</head>
<body>
<h1>匿名P2Pラジオ</h1>

<div>
  <button id="startBroadcast">匿名で配信開始</button>
  <button id="stopBroadcast" disabled>配信終了</button>
</div>

<div id="programs"></div>
<audio id="audio" controls autoplay></audio>

<script>
const WORKER_URL = 'https://sound.kcjsakcjsa.workers.dev/?token=公開用トークン';
let uid = crypto.randomUUID(); // 配信者用匿名ID
let pc;

// 配信開始
document.getElementById('startBroadcast').onclick = async () => {
  const title = prompt("番組タイトルを入力");
  if(!title) return;

  await fetch(`${WORKER_URL}&action=start&uid=${uid}&title=${encodeURIComponent(title)}`);

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    pc = new RTCPeerConnection();
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    pc.onicecandidate = async e => {
      if(e.candidate){
        await fetch(`${WORKER_URL}&action=signal&uid=${uid}&data=${encodeURIComponent(JSON.stringify({candidate:e.candidate}))}`);
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await fetch(`${WORKER_URL}&action=signal&uid=${uid}&data=${encodeURIComponent(JSON.stringify(offer))}`);

    document.getElementById('startBroadcast').disabled = true;
    document.getElementById('stopBroadcast').disabled = false;
    alert("配信中です。番組ID: "+uid);
  } catch(err){
    alert("マイクの使用が許可されませんでした: " + err.message);
  }
};

// 配信終了
document.getElementById('stopBroadcast').onclick = async () => {
  if(pc) pc.close();
  await fetch(`${WORKER_URL}&action=stop&uid=${uid}`);
  document.getElementById('startBroadcast').disabled = false;
  document.getElementById('stopBroadcast').disabled = true;
  alert("配信終了しました");
};

// 番組リスト取得と「聞く」ボタン生成
const programsDiv = document.getElementById('programs');
async function fetchPrograms() {
  try {
    const resp = await fetch(`${WORKER_URL}&action=list`);
    const programs = await resp.json();
    programsDiv.innerHTML = '';

    for(const hostUid in programs){
      const div = document.createElement('div');
      div.className = 'program';
      div.innerHTML = `<span>${programs[hostUid].title}</span> <button>聞く</button>`;
      div.querySelector('button').onclick = () => listenTo(hostUid);
      programsDiv.appendChild(div);
    }
  } catch(e){ console.error(e) }
}
setInterval(fetchPrograms, 3000);
fetchPrograms();

// リスナー側 WebRTC 聴取（ICE candidate 交換対応）
async function listenTo(hostUid){
  const pc = new RTCPeerConnection();
  const audio = document.getElementById('audio');
  pc.ontrack = e => { audio.srcObject = e.streams[0]; }

  pc.onicecandidate = async e => {
    if(e.candidate){
      await fetch(`${WORKER_URL}&action=signal&uid=${hostUid}&data=${encodeURIComponent(JSON.stringify({candidate:e.candidate}))}`);
    }
  };

  // Offer 作成
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // Worker に送信
  await fetch(`${WORKER_URL}&action=signal&uid=${hostUid}&data=${encodeURIComponent(JSON.stringify(offer))}`);

  // Answer をポーリング
  let answer = null;
  let knownCandidates = [];
  while(!answer){
    const resp = await fetch(`${WORKER_URL}&action=getSignal&uid=${hostUid}`);
    const data = await resp.json();
    if(data.sdp && data.sdp.type === 'answer') answer = data.sdp;

    // ICE candidate も追加
    if(data.candidates){
      for(const c of data.candidates){
        if(!knownCandidates.includes(c.candidate)){
          knownCandidates.push(c.candidate);
          pc.addIceCandidate(c);
        }
      }
    }
    await new Promise(r=>setTimeout(r,1000));
  }
  await pc.setRemoteDescription(answer);

  alert(`"${programsDiv.querySelector(`.program button[onclick*='${hostUid}']`).parentNode.firstChild.textContent}" を聴取中`);
}
</script>
</body>
</html>
